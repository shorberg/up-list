<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Reliable Superstore BDC Online Up List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#f6f8fb; --ink:#0f1a2a; --muted:#5b6b7a; --line:#e6eaf0; --accent:#2f67ff;
      --thead:#0f172a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;padding:20px}
    h1{margin:0 0 8px 0}
    .bar{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    input,select,textarea{height:28px;padding:4px 8px;border:1px solid var(--line);border-radius:6px;background:#fff;font-size:13px}
    textarea{resize:none}
    button{height:28px;padding:0 8px;border:1px solid var(--line);border-radius:6px;background:#fff;cursor:pointer;font-size:12px}
    button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{border:1px solid var(--line);padding:6px;vertical-align:middle;font-size:13px}
    thead th{background:var(--thead);color:#fff;text-align:left}
    td.center{text-align:center}
    .blackX{color:#000;font-weight:800}
    .redX{color:#e03131;font-weight:900}
    .muted{color:var(--muted)}
    .card{margin-top:18px;background:#fff;border:1px solid var(--line);border-radius:10px;overflow:hidden}
    .card thead th{background:#2f2f2f}
    input.nameEdit{height:24px;font-size:13px;min-width:200px;width:100%;}
    .removeBtn{color:#e03131;font-weight:bold;cursor:pointer;border:none;background:none;font-size:16px;}
    .dragHandle{cursor:grab;font-size:18px;text-align:center;}
    tr.dragging{opacity:0.5}
    input.apptEdit{width:60px;text-align:center}
  </style>
</head>
<body>
  <h1>Reliable Superstore BDC Online Up List</h1>
  <div class="muted"><span id="today"></span> • <span id="clock"></span> • Total Appointments Today: <b id="apptTotal">0</b></div>

  <div class="bar">
    <input id="nameInput" type="text" placeholder="Add team member name" />
    <button class="primary" id="addBtn">Add</button>
    <button id="nextBtn">Next Lead</button>
    <button id="resetBtn">Reset</button>
    <button id="newDayBtn">New Day</button>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:40px">⇅</th>
        <th style="width:250px">Name</th>
        <th style="width:100px">Status</th>
        <th style="width:50px">Up</th>
        <th style="width:70px">Leads</th>
        <th style="width:110px">Last Lead</th>
        <th style="width:100px">Makeups</th>
        <th style="width:180px">Actions</th>
        <th style="width:200px">Schedule Today</th>
        <th style="width:40px">Remove</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Leaderboard (Today)</th>
          <th>Appointments Set</th>
        </tr>
      </thead>
      <tbody id="leaderboard"></tbody>
    </table>
  </div>

<script>
  const SUPABASE_URL = "https://imfzlhudhljathvkgkqf.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltZnpsaHVkaGxqYXRodmtna3FmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MDAxMDUsImV4cCI6MjA3MzM3NjEwNX0.Bb-SUJMWfzVMHkdYuAgAD31wExcLuNazss6AJ11Z_VQ";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const tbody=document.getElementById("tbody");
  const leaderEl=document.getElementById("leaderboard");
  const apptTotalEl=document.getElementById("apptTotal");
  const nameInput=document.getElementById("nameInput");

  // Clock
  function tick(){
    const d=new Date();
    document.getElementById("today").textContent=
      d.toLocaleDateString(undefined,{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    document.getElementById("clock").textContent=
      d.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit',second:'2-digit'});
  }
  setInterval(tick,1000); tick();

  // Fetchers
  async function fetchPeople(){ 
    const {data,error}=await supabase.from("people").select("*").order("order",{ascending:true}); 
    if(error){console.error(error);return [];} 
    return data||[]; 
  }
  async function fetchMakeups(){ 
    const {data,error}=await supabase.from("makeups").select("*"); 
    if(error){console.error(error);return [];} 
    return data||[]; 
  }

  // Helpers
  function buildMakeupCountMap(makeups){ const map=new Map(); makeups.forEach(m=>map.set(m.person_id,(map.get(m.person_id)||0)+1)); return map; }
  function fmtTime(ts){ if(!ts) return ""; const d=new Date(ts); if(isNaN(d.getTime())) return ts; return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }

  // Actions
  async function addPerson(){
    const raw=nameInput.value.trim();
    if(!raw) return;
    const fixed=raw.charAt(0).toUpperCase()+raw.slice(1);
    const people=await fetchPeople();
    const nextOrder=people.length?Math.max(...people.map(p=>p.order||0))+1:1;
    const anyUp=people.some(p=>p.is_up);
    await supabase.from("people").insert([{
      name:fixed,status:"Here",is_up:!anyUp && people.length===0,order:nextOrder,
      leads:0,last_served:null,schedule:"",appointments_count:0,updated_at:new Date().toISOString()
    }]);
    nameInput.value="";
    refresh();
  }

  async function onNameChange(id,val){ await supabase.from("people").update({name:val}).eq("id",id); refresh(); }
  async function onStatusChange(id,val){ await supabase.from("people").update({status:val}).eq("id",id); refresh(); }
  async function onNeedMakeup(id){ const {data:p}=await supabase.from("people").select("leads").eq("id",id).single(); if(p){ await supabase.from("people").update({leads:Math.max(0,(p.leads||0)-1)}).eq("id",id);} await supabase.from("makeups").insert([{person_id:id}]); refresh(); }
  async function onSetAppt(id){ 
    const {data:p}=await supabase.from("people").select("appointments_count").eq("id",id).single();
    const newCount=(p?.appointments_count||0)+1;
    await supabase.from("people").update({appointments_count:newCount,updated_at:new Date().toISOString()}).eq("id",id);
    refresh();
  }
  async function onScheduleChange(id,val){ await supabase.from("people").update({schedule:val}).eq("id",id); }
  async function onRemove(id){ await supabase.from("makeups").delete().eq("person_id",id); await supabase.from("people").delete().eq("id",id); refresh(); }

  async function nextLead(){ 
    const [people,makeups]=await Promise.all([fetchPeople(),fetchMakeups()]); 
    if(!people.length) return; 
    if(makeups.length>0){ 
      const mu=makeups[0]; 
      const person=people.find(p=>p.id===mu.person_id); 
      if(person){ await supabase.from("people").update({leads:(person.leads||0)+1,last_served:new Date().toISOString()}).eq("id",mu.person_id);} 
      await supabase.from("makeups").delete().eq("id",mu.id); 
      return refresh(); 
    } 
    const here=people.filter(p=>p.status!=="Gone"); 
    if(here.length===0) return; 
    let current=people.find(p=>p.is_up); 
    if(!current||current.status==="Gone"){ await supabase.from("people").update({is_up:false}).not("id","is",null); await supabase.from("people").update({is_up:true}).eq("id",here[0].id); return refresh(); } 
    await supabase.from("people").update({leads:(current.leads||0)+1,last_served:new Date().toISOString(),is_up:false}).eq("id",current.id); 
    const curIdx=people.findIndex(p=>p.id===current.id); 
    const n=people.length; let nextId=null; 
    for(let step=1;step<=n;step++){ const idx=(curIdx+step)%n; if(people[idx].status!=="Gone"){ nextId=people[idx].id; break; }} 
    if(nextId) await supabase.from("people").update({is_up:true}).eq("id",nextId); 
    refresh(); 
  }

  async function resetAll(){
    // Reset all rows
    await supabase.from("people").update({
      leads:0,
      last_served:null,
      is_up:false,
      schedule:"",
      appointments_count:0,
      status:"Here",
      updated_at:new Date().toISOString()
    }).not("id","is",null);

    // Clear makeups
    await supabase.from("makeups").delete().not("id","is",null);

    // Reassign first available person as up
    const people=await fetchPeople();
    const firstHere=(people||[]).find(p=>p.status!=="Gone");
    if(firstHere) {
      await supabase.from("people").update({is_up:true}).eq("id",firstHere.id);
    }

    refresh();
  }

  async function newDay(){ 
    await supabase.from("makeups").delete().not("id","is",null); 
    await supabase.from("people").delete().not("id","is",null); 
    refresh(); 
  }

  // Drag & Drop
  function enableDrag(tr,id){ tr.draggable=true; tr.addEventListener("dragstart",e=>{ tr.classList.add("dragging"); }); tr.addEventListener("dragend",e=>{ tr.classList.remove("dragging"); }); tr.addEventListener("dragover",e=>{ e.preventDefault(); const dragging=document.querySelector("tr.dragging"); if(dragging&&tr!==dragging){ const rect=tr.getBoundingClientRect(); const next=(e.clientY-rect.top)>rect.height/2; tbody.insertBefore(dragging,next?tr.nextSibling:tr); } }); tr.addEventListener("drop",async e=>{ e.preventDefault(); const rows=Array.from(tbody.children); for(let i=0;i<rows.length;i++){ const rowId=rows[i].dataset.id; await supabase.from("people").update({order:i+1}).eq("id",rowId);} refresh(); }); }

  function renderTable(people,muMap){ 
    tbody.innerHTML=""; 
    (people||[]).forEach(p=>{ 
      const tr=document.createElement("tr"); 
      tr.dataset.id=p.id; 
      enableDrag(tr,p.id); 
      const muCount=muMap.get(p.id)||0; 
      const up=p.is_up?'<span class="blackX">X</span>':""; 
      const reds=muCount>0?'<span class="redX">'+"X".repeat(muCount)+'</span>':""; 
      tr.innerHTML=`
        <td class="dragHandle">☰</td>
        <td><input class="nameEdit" value="${p.name ?? ""}" onchange="onNameChange('${p.id}',this.value)" /></td>
        <td><select onchange="onStatusChange('${p.id}',this.value)"><option ${p.status==="Here"?"selected":""}>Here</option><option ${p.status==="Gone"?"selected":""}>Gone</option></select></td>
        <td class="center">${up}</td>
        <td>${p.leads ?? 0}</td>
        <td>${fmtTime(p.last_served)}</td>
        <td class="center">${reds}</td>
        <td><button onclick="onNeedMakeup('${p.id}')">Makeup</button><button onclick="onSetAppt('${p.id}')">Appt</button><button onclick="onMoveXHere('${p.id}')">X</button></td>
        <td><textarea onchange="onScheduleChange('${p.id}',this.value)">${p.schedule||""}</textarea></td>
        <td class="center"><button class="removeBtn" onclick="onRemove('${p.id}')">×</button></td>`; 
      tbody.appendChild(tr); 
    }); 
  }

  async function renderLeaderboard(){ 
    const { data: people, error } = await supabase.from("people").select("id,name,appointments_count,updated_at"); 
    if (error) { console.error(error); return; }
    let todayTotal=0; 
    const rows=(people||[]).map(p=>{ todayTotal+=p.appointments_count||0; return {id:p.id,name:p.name,count:p.appointments_count||0,last:p.updated_at}; }); 
    rows.sort((a,b)=>{ 
      if(b.count!==a.count) return b.count-a.count; 
      const al=a.last?new Date(a.last).getTime():0; 
      const bl=b.last?new Date(b.last).getTime():0; 
      return bl-al; 
    }); 
    leaderEl.innerHTML=""; 
    rows.forEach(r=>{ 
      const tr=document.createElement("tr"); 
      tr.innerHTML=`<td>${r.name}</td>
        <td><input class="apptEdit" type="number" value="${r.count}" onchange="onApptChange('${r.id}', this.value)" /></td>`; 
      leaderEl.appendChild(tr); 
    }); 
    apptTotalEl.textContent=todayTotal; 
  }

  async function onApptChange(id,val){
    const count=parseInt(val,10)||0;
    await supabase.from("people").update({appointments_count:count,updated_at:new Date().toISOString()}).eq("id",id);
    refresh();
  }

  async function refresh(){ 
    const [people,makeups]=await Promise.all([fetchPeople(),fetchMakeups()]); 
    const muMap=buildMakeupCountMap(makeups); 
    renderTable(people,muMap); 
    renderLeaderboard(); 
  }

  // Wire
  document.getElementById("addBtn").onclick=addPerson;
  document.getElementById("nextBtn").onclick=nextLead;
  document.getElementById("resetBtn").onclick=resetAll;
  document.getElementById("newDayBtn").onclick=newDay;
  nameInput.addEventListener("keydown",e=>{ if(e.key==="Enter") addPerson(); });

  // Init
  refresh();
  setInterval(refresh,5000);
</script>
</body>
</html>
