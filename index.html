<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Reliable Superstore BDC Online Up List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background: #f6f8fb; }
    .wrap { max-width: 1100px; margin: 20px auto; padding: 0 15px; }
    header { margin-bottom: 15px; }
    h1 { margin: 0; font-size: 22px; }
    .sub { color: #666; font-size: 13px; }
    .bar { display: flex; gap: 8px; margin: 12px 0; }
    input[type=text] { flex: 1; padding: 6px 8px; }
    button { padding: 6px 10px; cursor: pointer; border-radius: 6px; }
    button.primary { background: #2f67ff; color: #fff; border: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #fff; }
    thead th { background: #0f172a; color: #fff; padding: 8px; font-size: 13px; text-align: left; }
    tbody td { padding: 6px; border-top: 1px solid #ddd; font-size: 14px; }
    .tag { padding: 2px 6px; border-radius: 999px; font-size: 12px; }
    .tag.ok { background: #edfff5; color: #1f9d55; border: 1px solid #b8eecf; }
    .tag.bad { background: #fff5f5; color: #c92a2a; border: 1px solid #ffd4d4; }
    .right button { font-size: 12px; margin-right: 4px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Reliable Superstore BDC Online Up List</h1>
      <div class="sub">
        <span id="today"></span> • <span id="clock"></span> • Total Appointments Today: <b id="apptTotal">0</b>
      </div>
    </header>

    <div class="bar">
      <input id="nameInput" type="text" placeholder="Add team member name" />
      <button class="primary" onclick="addPerson()">Add</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Order</th>
          <th>Name</th>
          <th>Status</th>
          <th>Up</th>
          <th>Leads</th>
          <th>Last Lead</th>
          <th>Actions</th>
          <th>Schedule Today</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <h3 style="margin-top:20px">Leaderboard</h3>
    <table>
      <thead><tr><th>Name</th><th>Appointments Set</th></tr></thead>
      <tbody id="leader"></tbody>
    </table>
  </div>

<script>
  // ====== CONFIG ======
  const SUPABASE_URL = "https://imfzlhudhljathvkgkqf.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltZnpsaHVkaGxqYXRodmtna3FmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MDAxMDUsImV4cCI6MjA3MzM3NjEwNX0.Bb-SUJMWfzVMHkdYuAgAD31wExcLuNazss6AJ11Z_VQ";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const tbody = document.getElementById("tbody");
  const leader = document.getElementById("leader");
  const nameInput = document.getElementById("nameInput");
  const apptTotal = document.getElementById("apptTotal");

  // ====== CLOCK ======
  function tick() {
    const d = new Date();
    document.getElementById("today").textContent = d.toLocaleDateString();
    document.getElementById("clock").textContent = d.toLocaleTimeString();
  }
  setInterval(tick, 1000); tick();

  // ====== CRUD HELPERS ======
  async function fetchPeople() {
    let { data, error } = await supabase.from("people").select("*").order("order", { ascending: true });
    if (error) { console.error(error); return []; }
    return data;
  }

  async function addPerson() {
    const name = nameInput.value.trim();
    if (!name) return;
    await supabase.from("people").insert([{ name, status: "Here", is_up: false, order: Date.now(), leads: 0, appointments: 0 }]);
    nameInput.value = "";
  }

  async function setGone(id) {
    await supabase.from("people").update({ status: "Gone", is_up: false }).eq("id", id);
  }

  async function markX(id) {
    await supabase.from("people").update({ is_up: true }).eq("id", id);
  }

  async function needMakeup(id) {
    await supabase.from("people").update({ makeups: supabase.rpc('increment_makeups', { row_id: id }) }).eq("id", id);
  }

  async function setAppt(id) {
    const now = new Date().toISOString();
    await supabase.from("people").update({
      appointments: supabase.sql`appointments + 1`,
      last_appt_time: now
    }).eq("id", id);
  }

  // ====== RENDER ======
  function renderTable(people) {
    tbody.innerHTML = "";
    leader.innerHTML = "";
    let totalAppts = 0;

    people.forEach((p, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i + 1}</td>
        <td>${p.name}</td>
        <td><span class="tag ${p.status === "Here" ? "ok" : "bad"}">${p.status}</span></td>
        <td>${p.is_up ? "❌" : ""}</td>
        <td>${p.leads || 0}</td>
        <td>${p.last_served || ""}</td>
        <td class="right">
          <button onclick="setGone('${p.id}')">Set Gone</button>
          <button onclick="markX('${p.id}')">Mark X</button>
          <button onclick="needMakeup('${p.id}')">Need Makeup</button>
          <button onclick="setAppt('${p.id}')">Set Appt</button>
        </td>
        <td>${p.schedule || ""}</td>
      `;
      tbody.appendChild(tr);

      // leaderboard row
      const lr = document.createElement("tr");
      lr.innerHTML = `<td>${p.name}</td><td>${p.appointments || 0}</td>`;
      leader.appendChild(lr);

      totalAppts += p.appointments || 0;
    });

    apptTotal.textContent = totalAppts;
  }

  // ====== INIT & REALTIME ======
  async function init() {
    renderTable(await fetchPeople());

    supabase.channel('public:people')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'people' },
        async () => renderTable(await fetchPeople())
      )
      .subscribe();
  }
  init();
</script>
</body>
</html>