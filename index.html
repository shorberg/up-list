<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Reliable Superstore BDC Online Up List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f6f8fb; margin:0; padding:20px; }
    h1 { margin:0 0 8px; }
    .bar { margin:12px 0; display:flex; gap:8px; flex-wrap:wrap; }
    input, select, textarea { padding:6px; border:1px solid #ccc; border-radius:6px; }
    textarea { resize:none; height:28px; }
    button { padding:6px 10px; border:1px solid #ccc; border-radius:6px; background:#fff; cursor:pointer; }
    button.primary { background:#2f67ff; color:#fff; border-color:#2f67ff; }
    table { width:100%; border-collapse:collapse; background:#fff; margin-top:12px; }
    th, td { border:1px solid #ddd; padding:6px; text-align:left; vertical-align:middle; }
    thead th { background:#0f172a; color:#fff; }
    td.center { text-align:center; }
    .blackX { color:black; font-weight:bold; }
    .redX { color:red; font-weight:bold; }
    .muted { color:#5b6b7a; }
    .card { margin-top:20px; background:#fff; border:1px solid #ccc; border-radius:8px; overflow:hidden; }
    .card th { background:#2f2f2f; }
  </style>
</head>
<body>
  <h1>Reliable Superstore BDC Online Up List</h1>
  <div class="muted">
    <span id="today"></span> • <span id="clock"></span> • 
    Total Appointments Today: <b id="apptTotal">0</b>
  </div>

  <div class="bar">
    <input id="nameInput" type="text" placeholder="Add team member name" />
    <button class="primary" id="addBtn">Add</button>
    <button id="nextBtn">Next Lead</button>
    <button id="resetBtn">Reset</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Order</th>
        <th>Name</th>
        <th>Status</th>
        <th>Up</th>
        <th>Leads</th>
        <th>Last Lead</th>
        <th>Makeups</th>
        <th>Schedule Today</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Leaderboard</th>
          <th>Appointments Set</th>
        </tr>
      </thead>
      <tbody id="leaderboard"></tbody>
    </table>
  </div>

<script>
  // === CONFIG ===
  const SUPABASE_URL = "https://imfzlhudhljathvkgkqf.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltZnpsaHVkaGxqYXRodmtna3FmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MDAxMDUsImV4cCI6MjA3MzM3NjEwNX0.Bb-SUJMWfzVMHkdYuAgAD31wExcLuNazss6AJ11Z_VQ";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const tbody = document.getElementById("tbody");
  const leaderEl = document.getElementById("leaderboard");
  const apptTotalEl = document.getElementById("apptTotal");

  // Clock
  function tick(){
    const d = new Date();
    document.getElementById("today").textContent =
      d.toLocaleDateString(undefined,{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    document.getElementById("clock").textContent =
      d.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit',second:'2-digit'});
  }
  setInterval(tick, 1000); tick();

  // Helpers
  async function fetchPeople() {
    const { data, error } = await supabase.from("people").select("*").order("order",{ascending:true});
    if (error) { console.error(error); return []; }
    return data || [];
  }
  async function fetchMakeups() {
    const { data } = await supabase.from("makeups").select("*").order("created_at",{ascending:true});
    return data || [];
  }
  function buildMakeupCountMap(makeups) {
    const map = new Map();
    makeups.forEach(m => map.set(m.person_id, (map.get(m.person_id)||0)+1));
    return map;
  }
  function fmtTime(ts) {
    if(!ts) return "";
    return new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  }

  // Actions
  async function addPerson(){
    const raw = document.getElementById("nameInput").value.trim();
    if(!raw) return;
    const fixed = raw.toLowerCase().replace(/\b\w/g, m=>m.toUpperCase());
    const people = await fetchPeople();
    const nextOrder = people.length? Math.max(...people.map(p=>p.order||0))+1:1;
    await supabase.from("people").insert([{
      name:fixed,status:"Here",is_up:people.length===0,order:nextOrder,
      leads:0,last_served:null,schedule:""
    }]);
    document.getElementById("nameInput").value="";
    refresh();
  }
  async function onNeedMakeup(id){
    const { data: person } = await supabase.from("people").select("leads").eq("id",id).single();
    await supabase.from("people").update({leads:Math.max(0,(person.leads||0)-1)}).eq("id",id);
    await supabase.from("makeups").insert([{person_id:id}]);
    refresh();
  }
  async function onMoveXHere(id){
    await supabase.from("people").update({is_up:false}).neq("id",id);
    await supabase.from("people").update({is_up:true}).eq("id",id);
    refresh();
  }
  async function onRemove(id){
    await supabase.from("makeups").delete().eq("person_id",id);
    await supabase.from("people").delete().eq("id",id);
    refresh();
  }
  async function onStatusChange(id,val){
    await supabase.from("people").update({status:val}).eq("id",id);
    refresh();
  }
  async function onScheduleChange(id,val){
    await supabase.from("people").update({schedule:val}).eq("id",id);
  }
  async function onSetAppt(id){
    await supabase.from("appointments").insert([{person_id:id}]);
    refresh();
  }

  async function nextLead(){
    const [people,makeups] = await Promise.all([fetchPeople(),fetchMakeups()]);
    if(!people.length) return;
    if(makeups.length>0){
      const mu = makeups[0];
      const person = people.find(p=>p.id===mu.person_id);
      await supabase.from("people").update({
        leads:(person.leads||0)+1,last_served:new Date().toISOString()
      }).eq("id",mu.person_id);
      await supabase.from("makeups").delete().eq("id",mu.id);
      return refresh();
    }
    const current = people.find(p=>p.is_up);
    if(!current){
      await supabase.from("people").update({is_up:true}).eq("id",people[0].id);
      return refresh();
    }
    await supabase.from("people").update({
      leads:(current.leads||0)+1,last_served:new Date().toISOString(),is_up:false
    }).eq("id",current.id);
    const idx = people.findIndex(p=>p.id===current.id);
    const nextIdx=(idx+1)%people.length;
    await supabase.from("people").update({is_up:true}).eq("id",people[nextIdx].id);
    refresh();
  }

  async function resetAll(){
    await supabase.from("people").update({leads:0,last_served:null,is_up:false,schedule:""});
    await supabase.from("makeups").delete().neq("id","00000000-0000-0000-0000-000000000000");
    await supabase.from("appointments").delete().neq("id","00000000-0000-0000-0000-000000000000");
    refresh();
  }

  // Render
  function renderTable(people,muMap){
    tbody.innerHTML="";
    people.forEach(p=>{
      const tr=document.createElement("tr");
      const muCount=muMap.get(p.id)||0;
      const up=p.is_up?'<span class="blackX">X</span>':"";
      const reds=muCount>0?'<span class="redX">'+"X".repeat(muCount)+'</span>':"";
      tr.innerHTML=`
        <td>${p.order}</td>
        <td>${p.name}</td>
        <td>
          <select onchange="onStatusChange('${p.id}',this.value)">
            <option ${p.status==="Here"?"selected":""}>Here</option>
            <option ${p.status==="Gone"?"selected":""}>Gone</option>
          </select>
        </td>
        <td class="center">${up}</td>
        <td>${p.leads||0}</td>
        <td>${fmtTime(p.last_served)}</td>
        <td class="center">${reds}</td>
        <td><textarea onchange="onScheduleChange('${p.id}',this.value)">${p.schedule||""}</textarea></td>
        <td>
          <button onclick="onNeedMakeup('${p.id}')">Need Makeup</button>
          <button onclick="onSetAppt('${p.id}')">Set Appt</button>
          <button onclick="onMoveXHere('${p.id}')">X</button>
          <button onclick="onRemove('${p.id}')">Remove</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function renderLeaderboard(){
    const { data, error } = await supabase.from("appointments").select("person_id, created_at");
    if(error){ console.error(error); return; }
    const { data: people } = await supabase.from("people").select("id,name");
    let counts={};
    data.forEach(a=>{
      if(!counts[a.person_id]) counts[a.person_id]={count:0,last:a.created_at};
      counts[a.person_id].count++;
      if(new Date(a.created_at)>new Date(counts[a.person_id].last)){
        counts[a.person_id].last=a.created_at;
      }
    });
    let rows=Object.entries(counts).map(([pid,info])=>{
      const person=people.find(p=>p.id===pid);
      return {name:person?person.name:"?",count:info.count,last:new Date(info.last)};
    });
    rows.sort((a,b)=> b.count===a.count ? b.last-a.last : b.count-a.count );
    leaderEl.innerHTML="";
    rows.forEach(r=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${r.name}</td><td>${r.count}</td>`;
      leaderEl.appendChild(tr);
    });
    apptTotalEl.textContent=data.length;
  }

  async function refresh(){
    const [people,makeups]=await Promise.all([fetchPeople(),fetchMakeups()]);
    const muMap=buildMakeupCountMap(makeups);
    renderTable(people,muMap);
    renderLeaderboard();
  }

  // Wire
  document.getElementById("addBtn").onclick=addPerson;
  document.getElementById("nextBtn").onclick=nextLead;
  document.getElementById("resetBtn").onclick=resetAll;
  document.getElementById("nameInput").addEventListener("keydown",e=>{if(e.key==="Enter")addPerson();});

  refresh();
  setInterval(refresh,5000);
</script>
</body>
</html>
