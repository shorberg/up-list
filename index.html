<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Reliable Superstore BDC Online Up List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f6f8fb; }
    h1 { margin-bottom: 10px; }
    .bar { margin-bottom: 15px; }
    input, button { padding: 6px 10px; margin-right: 6px; }
    table { width: 100%; border-collapse: collapse; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    thead { background: #0f172a; color: #fff; }
    .up { font-weight: bold; }
    .x { font-weight: bold; color: black; }
  </style>
</head>
<body>
  <h1>Reliable Superstore BDC Online Up List</h1>

  <div class="bar">
    <input id="nameInput" type="text" placeholder="Add team member name" />
    <button id="addBtn">Add</button>
    <button id="nextBtn">Next Lead (move X)</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Order</th>
        <th>Name</th>
        <th>Up</th>
        <th>Leads</th>
        <th>Last Lead</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

<script>
  // === CONFIG ===
  const SUPABASE_URL = "https://imfzlhudhljathvkgkqf.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltZnpsaHVkaGxqYXRodmtna3FmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MDAxMDUsImV4cCI6MjA3MzM3NjEwNX0.Bb-SUJMWfzVMHkdYuAgAD31wExcLuNazss6AJ11Z_VQ";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const tbody = document.getElementById("tbody");
  const nameInput = document.getElementById("nameInput");

  async function fetchPeople() {
    const { data, error } = await supabase
      .from("people")
      .select("*")
      .order("order", { ascending: true });
    if (error) { console.error(error); return []; }
    return data || [];
  }

  function renderRow(p) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.order}</td>
      <td>${p.name}</td>
      <td>${p.is_up ? '<span class="x">X</span>' : ''}</td>
      <td>${p.leads || 0}</td>
      <td>${p.last_served ? new Date(p.last_served).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : ''}</td>
    `;
    return tr;
  }

  async function refreshTable() {
    tbody.innerHTML = "";
    const people = await fetchPeople();
    people.forEach(p => tbody.appendChild(renderRow(p)));
  }

  async function addPerson() {
    const name = nameInput.value.trim();
    if (!name) return;

    const people = await fetchPeople();
    const nextOrder = people.length ? Math.max(...people.map(p => p.order)) + 1 : 1;

    const fixed = name.toLowerCase().replace(/\b\w/g, m => m.toUpperCase());

    await supabase.from("people").insert([
      { name: fixed, order: nextOrder, is_up: people.length === 0, leads: 0 }
    ]);

    nameInput.value = "";
    refreshTable();
  }

  async function nextLead() {
    const people = await fetchPeople();
    if (people.length === 0) return;

    // find current "up"
    const current = people.find(p => p.is_up);
    if (!current) {
      // no one marked as up, set first person
      await supabase.from("people").update({ is_up: true }).eq("id", people[0].id);
      return refreshTable();
    }

    // give current person a lead
    await supabase.from("people").update({
      leads: (current.leads || 0) + 1,
      last_served: new Date().toISOString(),
      is_up: false
    }).eq("id", current.id);

    // find next in order
    let idx = people.findIndex(p => p.id === current.id);
    let nextIdx = (idx + 1) % people.length;
    let next = people[nextIdx];

    // mark next person as up
    await supabase.from("people").update({ is_up: true }).eq("id", next.id);

    refreshTable();
  }

  document.getElementById("addBtn").addEventListener("click", addPerson);
  document.getElementById("nextBtn").addEventListener("click", nextLead);

  refreshTable();
  setInterval(refreshTable, 5000); // refresh every 5s
</script>
</body>
</html>
