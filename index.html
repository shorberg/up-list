<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Reliable Superstore BDC Online Up List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f6f8fb; }
    h1 { margin-bottom: 10px; }
    .bar { margin-bottom: 15px; }
    input, button { padding: 6px 10px; margin-right: 6px; }
    table { width: 100%; border-collapse: collapse; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    thead { background: #0f172a; color: #fff; }
    .x { font-weight: bold; color: black; }
    .rx { font-weight: bold; color: red; margin-left: 4px; }
  </style>
</head>
<body>
  <h1>Reliable Superstore BDC Online Up List</h1>

  <div class="bar">
    <input id="nameInput" type="text" placeholder="Add team member name" />
    <button id="addBtn">Add</button>
    <button id="nextBtn">Next Lead (move X)</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Order</th>
        <th>Name</th>
        <th>Up</th>
        <th>Leads</th>
        <th>Last Lead</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

<script>
  // === CONFIG ===
  const SUPABASE_URL = "https://imfzlhudhljathvkgkqf.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltZnpsaHVkaGxqYXRodmtna3FmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MDAxMDUsImV4cCI6MjA3MzM3NjEwNX0.Bb-SUJMWfzVMHkdYuAgAD31wExcLuNazss6AJ11Z_VQ";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const tbody = document.getElementById("tbody");
  const nameInput = document.getElementById("nameInput");

  async function fetchPeople() {
    const { data, error } = await supabase
      .from("people")
      .select("*")
      .order("order", { ascending: true });
    if (error) { console.error(error); return []; }
    return data || [];
  }

  function fmtTime(ts) {
    if (!ts) return "";
    return new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }

  function renderRow(p) {
    const tr = document.createElement("tr");
    let upDisplay = "";
    if (p.is_up) upDisplay = '<span class="x">X</span>';
    if (p.makeup_count && p.makeup_count > 0) {
      upDisplay += " " + "❌".repeat(p.makeup_count);
    }
    tr.innerHTML = `
      <td>${p.order}</td>
      <td>${p.name}</td>
      <td>${upDisplay}</td>
      <td>${p.leads || 0}</td>
      <td>${fmtTime(p.last_served)}</td>
      <td>
        <button onclick="needMakeup(${p.id}, ${p.leads || 0})">Need Makeup</button>
      </td>
    `;
    return tr;
  }

  async function refreshTable() {
    tbody.innerHTML = "";
    const people = await fetchPeople();
    people.forEach(p => tbody.appendChild(renderRow(p)));
  }

  async function addPerson() {
    const name = nameInput.value.trim();
    if (!name) return;

    const people = await fetchPeople();
    const nextOrder = people.length ? Math.max(...people.map(p => p.order)) + 1 : 1;
    const fixed = name.toLowerCase().replace(/\b\w/g, m => m.toUpperCase());

    await supabase.from("people").insert([
      { name: fixed, order: nextOrder, is_up: people.length === 0, leads: 0, makeup_count: 0 }
    ]);

    nameInput.value = "";
    refreshTable();
  }

  async function nextLead() {
    const people = await fetchPeople();
    if (people.length === 0) return;

    // Anyone with makeup?
    const makeup = people.find(p => p.makeup_count && p.makeup_count > 0);
    if (makeup) {
      await supabase.from("people").update({
        leads: (makeup.leads || 0) + 1,
        last_served: new Date().toISOString(),
        makeup_count: makeup.makeup_count - 1
      }).eq("id", makeup.id);
      return refreshTable();
    }

    // Find current "up"
    const current = people.find(p => p.is_up);
    if (!current) {
      await supabase.from("people").update({ is_up: true }).eq("id", people[0].id);
      return refreshTable();
    }

    // Give current person a lead
    await supabase.from("people").update({
      leads: (current.leads || 0) + 1,
      last_served: new Date().toISOString(),
      is_up: false
    }).eq("id", current.id);

    // Rotate to next
    let idx = people.findIndex(p => p.id === current.id);
    let nextIdx = (idx + 1) % people.length;
    let next = people[nextIdx];

    await supabase.from("people").update({ is_up: true }).eq("id", next.id);

    refreshTable();
  }

  async function needMakeup(id, leads) {
    // reduce lead count and add a makeup
    await supabase.from("people").update({
      leads: Math.max(0, leads - 1),
      makeup_count: supabase.rpc('increment_makeup', { row_id: id })
    }).eq("id", id);

    // fallback if RPC not available → just increment makeup_count manually
    const { data } = await supabase.from("people").select("makeup_count").eq("id", id).single();
    if (data) {
      await supabase.from("people").update({
        makeup_count: (data.makeup_count || 0) + 1
      }).eq("id", id);
    }

    refreshTable();
  }

  document.getElementById("addBtn").addEventListener("click", addPerson);
  document.getElementById("nextBtn").addEventListener("click", nextLead);

  refreshTable();
  setInterval(refreshTable, 5000);
</script>
</body>
</html>
